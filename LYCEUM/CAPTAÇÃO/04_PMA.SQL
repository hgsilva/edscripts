-- GERANDO OS CANDIDATOS PMA ACUMULADOS

-- GERA LOG

INSERT INTO IE_ALUNO_PMA_ACUMULADO_V3_LOG
SELECT	*, GETDATE()DT_LOG 
FROM	IE_ALUNO_PMA_ACUMULADO_V3
where	ANO_INGRESSO IN (
							SELECT	DISTINCT ANO
							FROM	[POLARIS02\BDIESBPROD].LYCEUM.DBO.IE_LY_OPCOES_APP
							WHERE	APLICACAO in ( 'VESTIBULAR','VESTIBULAR_EAD_TRIMESTRAL')
							)

-- LIMPA A TB
delete IE_ALUNO_PMA_ACUMULADO_V3 where ANO_INGRESSO IN (
														SELECT	DISTINCT ANO
														FROM	[POLARIS02\BDIESBPROD].LYCEUM.DBO.IE_LY_OPCOES_APP
														WHERE	APLICACAO in ( 'VESTIBULAR','VESTIBULAR_EAD_TRIMESTRAL')
														)

-- GERA OS DADOS
DECLARE  @DATA DATETIME
		

	DECLARE cursor_gera_financeiro CURSOR FOR 

		select	convert(varchar, DATA, 102) as data
		from	[POLARIS02\BDIESBPROD].LYCEUM.DBO.IE_date
		where	data >='2017-11-03 00:00:00.000' AND data <= getdate()+1
		ORDER BY DATA

	OPEN cursor_gera_financeiro 
	FETCH NEXT FROM cursor_gera_financeiro INTO @DATA
      
	WHILE @@FETCH_STATUS = 0 
	BEGIN 

			INSERT INTO IE_ALUNO_PMA_ACUMULADO_V3
			
			SELECT	A.CANDIDATO
					,A.CONCURSO
					,A.ALUNO
					,AA.ANO_INGRESSO
					,AA.SEM_INGRESSO
					,A.CURSO
					--,CASE	WHEN GRUPO_CURSO IS NULL THEN B.FACULDADE ELSE GRUPO_CURSO END CAMPUS
					,CAMPI AS CAMPUS
					,A.MODALIDADE
					,A.DT_INGRESSO
					,GETDATE() DATA
					,A.turno
					,A.TIPO_CONCURSO
			FROM	[POLARIS02\BDIESBPROD].LYCEUM.DBO.VW_PAINEL_TURMAS_TODOSPERIODOS A --VW_PAINEL_TURMAS  A
			JOIN 	[POLARIS02\BDIESBPROD].LYCEUM.DBO.LY_ALUNO AA ON AA.ALUNO = A.ALUNO
			LEFT JOIN	[POLARIS02\BDIESBPROD].LYCEUM.DBO.LY_CURSO B ON A.CURSO = B.CURSO
			WHERE	convert(varchar, A.DT_INGRESSO, 102)  <= @DATA
			--AND		STAGE = 'PMA'
			AND PREMATRICULA = '1'
	
		
	FETCH NEXT FROM cursor_gera_financeiro 

	INTO  @DATA   
    

	END 
	CLOSE cursor_gera_financeiro 
	DEALLOCATE cursor_gera_financeiro