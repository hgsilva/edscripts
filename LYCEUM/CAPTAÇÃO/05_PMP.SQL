-- GERANDO OS CANDIDATOS PMP ACUMULADOS

-- GERA LOG

SELECT * INTO IE_ALUNO_PMP_ACUMULADO_V3_LOG FROM [POLARIS02\BDIESBPROD].LYCEUM.DBO.IE_ALUNO_PMP_ACUMULADO_V3_LOG


INSERT INTO IE_ALUNO_PMP_ACUMULADO_V3_LOG
SELECT	*, GETDATE()DT_LOG 
FROM	IE_ALUNO_PMP_ACUMULADO_V3
where	ANO_INGRESSO IN (
						SELECT	DISTINCT ANO
						FROM	[POLARIS02\BDIESBPROD].LYCEUM.DBO.IE_LY_OPCOES_APP
						WHERE	APLICACAO in ( 'VESTIBULAR','VESTIBULAR_EAD_TRIMESTRAL')
						) 


-- LIMPA A TB
delete IE_ALUNO_PMP_ACUMULADO_V3 WHERE ANO_INGRESSO IN (
														SELECT	DISTINCT ANO
														FROM	[POLARIS02\BDIESBPROD].LYCEUM.DBO.IE_LY_OPCOES_APP
														WHERE	APLICACAO in ( 'VESTIBULAR','VESTIBULAR_EAD_TRIMESTRAL')
														) 

-- GERA OS DADOS
insert INTO IE_ALUNO_PMP_ACUMULADO_V3
SELECT	distinct CANDIDATO
		,CO.CONCURSO
		,A.ALUNO
		,ANO_INGRESSO
		,SEM_INGRESSO
		,B.CURSO
		--,CASE	WHEN GRUPO_CURSO IS NULL THEN C.FACULDADE ELSE GRUPO_CURSO END CAMPUS
		,COALESCE(GRUPO_CURSO,COALESCE(b.UNIDADE_FISICA,COALESCE( Co.FACULDADE , C.FACULDADE ))) AS CAMPUS
		,CASE	WHEN COALESCE(INEP_PRESENCIAL,'P') = 'P' THEN 'Presencial' 
				WHEN COALESCE(INEP_PRESENCIAL,'P') = 'S' THEN 'Semipresencial' 
				WHEN COALESCE(INEP_PRESENCIAL,'P') = 'D' THEN 'Ead'
				ELSE 'Presencial'
				END MODALIDADE
		,DT_INGRESSO
		,DATA
		,TURNO	
		,CASE	WHEN co.CONCURSO LIKE 'IPS%ESPECIAL%'  or co.TIPO_CONCURSO ='Especial' THEN 'CONCURSO ESPECIAL'
														WHEN co.TIPO_CONCURSO  = 'Tradic'  THEN 'VESTIBULAR TRADICIONAL'                        
														WHEN co.TIPO_CONCURSO = 'VestAgend'  THEN 'VESTIBULAR AGENDADO'                        
														WHEN co.TIPO_CONCURSO = 'DCS'   THEN 'DCS'                        
														WHEN co.TIPO_CONCURSO = 'Transf'  THEN 'TRANSFERENCIA'                        
														WHEN co.TIPO_CONCURSO = 'MudancaCurso' THEN 'MUDANCA DE CURSO'                      
														WHEN co.TIPO_CONCURSO = 'Prouni'  THEN 'PROUNI'                        
														WHEN (co.CONCURSO LIKE  '%GDF%' or co.Tipo_concurso like '%GDF%')THEN 'GDF'
														WHEN co.CONCURSO LIKE  'IPS%ENEM%' or co.TIPO_CONCURSO ='ENEM' THEN 'ENEM'                        
														when co.CONCURSO LIKE  'IPSEAD%'  or co.TIPO_CONCURSO ='EADGraduacao' THEN 'EAD'  
														WHEN co.TIPO_CONCURSO='INTERESSE'   THEN 'INTERESSE'  
														Else 'Concurso não informado'
														END TIPO_CONCURSO 	  
FROM	[POLARIS02\BDIESBPROD].LYCEUM.DBO.IE_AL_ADIMP_MATRICULA_LOG_BI a
JOIN	[POLARIS02\BDIESBPROD].LYCEUM.DBO.LY_ALUNO B ON A.ALUNO = B.ALUNO 
JOIN	[POLARIS02\BDIESBPROD].LYCEUM.DBO.LY_CURSO C ON C.CURSO = B.CURSO
JOIN	[POLARIS02\BDIESBPROD].LYCEUM.DBO.LY_CONCURSO CO ON CO.CONCURSO = B.CONCURSO
WHERE	convert(varchar, DATA, 102) >= '2017.11.07' 
AND	A.ALUNO IN (SELECT ALUNO
				FROM [POLARIS02\BDIESBPROD].LYCEUM.DBO.LY_ALUNO 
				WHERE ANO_INGRESSO IN (
										SELECT	DISTINCT ANO
										FROM	[POLARIS02\BDIESBPROD].LYCEUM.DBO.IE_LY_OPCOES_APP
										WHERE	APLICACAO in ( 'VESTIBULAR','VESTIBULAR_EAD_TRIMESTRAL')
										) 
			)
AND 	SIT_ALUNO = 'ATIVO'